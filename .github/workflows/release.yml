name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build - ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: macOS (Apple Silicon)
            platform: macos-latest
            target: aarch64-apple-darwin
            bundles: dmg
          - name: macOS (Universal)
            platform: macos-latest
            target: universal-apple-darwin
            bundles: dmg
          - name: Windows (x64)
            platform: windows-latest
            target: x86_64-pc-windows-msvc
            bundles: nsis
    runs-on: ${{ matrix.platform }}
    env:
      TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies
        run: npm ci

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2" --locked

      - name: Generate Release Notes
        id: release_notes
        shell: bash
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 ${{ github.ref_name }}^ 2>/dev/null || git rev-list --max-parents=0 HEAD)
          echo "Previous tag: $PREV_TAG"
          
          LOGS=$(git log $PREV_TAG..${{ github.ref_name }} --pretty=format:"%s")
          
          FEATS=""
          FIXES=""
          DOCS=""
          OTHERS=""
          
          while IFS= read -r line; do
            [ -z "$line" ] && continue
            clean_line=$(echo "$line" | sed 's/\\/\\\\/g; s/`/\\`/g')
            
            if [[ $line =~ ^feat ]]; then
              FEATS="$FEATS\n- ${clean_line#feat: }"
            elif [[ $line =~ ^fix ]]; then
              FIXES="$FIXES\n- ${clean_line#fix: }"
            elif [[ $line =~ ^docs ]]; then
              DOCS="$DOCS\n- ${clean_line#docs: }"
            elif [[ $line =~ ^refactor ]] || [[ $line =~ ^perf ]]; then
              FIXES="$FIXES\n- ${clean_line}"
            else
              OTHERS="$OTHERS\n- ${clean_line}"
            fi
          done <<< "$LOGS"
          
          BODY=""
          [ -n "$FEATS" ] && BODY="$BODY\n### ðŸš€ æ–°åŠŸèƒ½$FEATS\n"
          [ -n "$FIXES" ] && BODY="$BODY\n### ðŸ”§ ä¿®å¤ä¸Žä¼˜åŒ–$FIXES\n"
          [ -n "$DOCS" ] && BODY="$BODY\n### ðŸ“ æ–‡æ¡£æ›´æ–°$DOCS\n"
          [ -n "$OTHERS" ] && BODY="$BODY\n### ðŸ“¦ å…¶ä»–æ”¹åŠ¨$OTHERS\n"
          [ -z "$BODY" ] && BODY="æœ¬æ¬¡å‘å¸ƒåŒ…å«å†…éƒ¨ä¼˜åŒ–ä¸Žç¨³å®šæ€§æå‡ã€‚"
          
          BUILD_TIME=$(TZ=Asia/Shanghai date "+%Y-%m-%d %H:%M:%S")
          {
            echo "body<<EOF"
            echo -e "$BODY"
            echo ""
            echo "---"
            echo "*æž„å»ºæ—¶é—´: $BUILD_TIME*"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Build Tauri app
        run: |
          cd src-tauri
          cargo tauri build --target ${{ matrix.target }} --bundles ${{ matrix.bundles }}
        env:
          CI: true

      - name: Generate Updater Signature (macOS)
        if: matrix.platform == 'macos-latest'
        shell: bash
        run: |
          if [ -z "${TAURI_SIGNING_PRIVATE_KEY:-}" ]; then
            echo "No signing key, skip signature generation"
            exit 0
          fi
          
          KEY_PATH="$RUNNER_TEMP/tauri-updater.key"
          printf '%s' "$TAURI_SIGNING_PRIVATE_KEY" > "$KEY_PATH"
          
          TARGET_DIR="src-tauri/target/${{ matrix.target }}/release/bundle/macos"
          UPDATE_BUNDLE=$(ls -1 "$TARGET_DIR"/*.app.tar.gz 2>/dev/null | head -n 1 || true)
          
          if [ -z "$UPDATE_BUNDLE" ]; then
            echo "No updater bundle found"
            exit 0
          fi
          
          npm run -s tauri -- signer sign -f "$KEY_PATH" -p "${TAURI_SIGNING_PRIVATE_KEY_PASSWORD:-}" "$UPDATE_BUNDLE"
          echo "Signature generated: ${UPDATE_BUNDLE}.sig"

      - name: Generate Updater Signature (Windows)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          if (-not $env:TAURI_SIGNING_PRIVATE_KEY) {
            Write-Host "No signing key, skip signature generation"
            exit 0
          }
          
          $keyPath = "$env:RUNNER_TEMP\tauri-updater.key"
          Set-Content -Path $keyPath -Value $env:TAURI_SIGNING_PRIVATE_KEY -NoNewline
          
          $targetDir = "src-tauri\target\${{ matrix.target }}\release\bundle\nsis"
          $setupExe = Get-ChildItem -Path $targetDir -Filter "*_x64-setup.exe" | Select-Object -First 1
          
          if (-not $setupExe) {
            Write-Host "No setup exe found"
            exit 0
          fi
          
          npm run tauri -- signer sign -f $keyPath -p "${env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD}" $setupExe.FullName
          Write-Host "Signature generated: $($setupExe.FullName).sig"

      - name: Prepare Release Assets (macOS)
        if: matrix.platform == 'macos-latest'
        shell: bash
        run: |
          mkdir -p release-assets
          TARGET_DIR="src-tauri/target/${{ matrix.target }}/release/bundle"
          
          if [ "${{ matrix.target }}" = "aarch64-apple-darwin" ]; then
            SUFFIX="_aarch64"
          else
            SUFFIX="_universal"
          fi
          
          # DMG
          if [ -d "$TARGET_DIR/dmg" ]; then
            for f in "$TARGET_DIR/dmg"/*.dmg; do
              [ -f "$f" ] && cp "$f" "release-assets/OMO_Switch${SUFFIX}.dmg"
            done
          fi
          
          # App bundle for updater
          if [ -d "$TARGET_DIR/macos" ]; then
            for f in "$TARGET_DIR/macos"/*.app.tar.gz; do
              [ -f "$f" ] && cp "$f" "release-assets/OMO_Switch${SUFFIX}.app.tar.gz"
            done
            for f in "$TARGET_DIR/macos"/*.app.tar.gz.sig; do
              [ -f "$f" ] && cp "$f" "release-assets/"
            done
          fi

      - name: Prepare Release Assets (Windows)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path release-assets
          $targetDir = "src-tauri\target\${{ matrix.target }}\release\bundle\nsis"
          
          $setupExe = Get-ChildItem -Path $targetDir -Filter "*_x64-setup.exe" | Select-Object -First 1
          if ($setupExe) {
            Copy-Item $setupExe.FullName "release-assets\OMO_Switch_x64-setup.exe"
            $sigFile = "$($setupExe.FullName).sig"
            if (Test-Path $sigFile) {
              Copy-Item $sigFile "release-assets\OMO_Switch_x64-setup.exe.sig"
            }
          }

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          name: OMO Switch ${{ github.ref_name }}
          body: ${{ steps.release_notes.outputs.body }}
          files: release-assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-updater-json:
    name: Publish Updater JSON
    needs: build-and-release
    if: always() && needs.build-and-release.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Generate latest.json
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.ref_name }}"
          REPO="${{ github.repository }}"
          
          echo "Fetching release info: $REPO $TAG"
          gh api -H 'Accept: application/vnd.github+json' "repos/${REPO}/releases/tags/${TAG}" > release.json
          
          python3 - <<'PY'
          import json, re, urllib.request, sys
          
          with open("release.json", "r", encoding="utf-8") as f:
            data = json.load(f)
          
          tag = data.get("tag_name") or ""
          version = tag[1:] if tag.startswith("v") else tag
          
          assets = data.get("assets") or []
          assets_by_name = {a.get("name"): a for a in assets if a.get("name")}
          
          def find_asset(patterns):
            for pat in patterns:
              rx = re.compile(pat)
              for name, a in assets_by_name.items():
                if rx.search(name):
                  return a
            return None
          
          # macOS bundles
          mac_arm = find_asset([r"OMO_Switch_aarch64\.app\.tar\.gz$"])
          mac_universal = find_asset([r"OMO_Switch_universal\.app\.tar\.gz$"])
          win_exe = find_asset([r"OMO_Switch_x64-setup\.exe$"])
          
          def sig_for(asset):
            if not asset:
              return None
            name = asset["name"]
            return assets_by_name.get(name + ".sig")
          
          mac_arm_sig = sig_for(mac_arm)
          mac_universal_sig = sig_for(mac_universal)
          win_sig = sig_for(win_exe)
          
          def fetch_text(url):
            try:
              with urllib.request.urlopen(url, timeout=30) as f:
                return f.read().decode("utf-8").strip()
            except Exception as e:
              print(f"Warning: Failed to fetch {url}: {e}", file=sys.stderr)
              return ""
          
          platforms = {}
          
          # Apple Silicon: ä¼˜å…ˆ aarch64ï¼Œfallback åˆ° universal
          if mac_arm and mac_arm_sig:
            sig_content = fetch_text(mac_arm_sig["browser_download_url"])
            if sig_content:
              platforms["darwin-aarch64"] = {
                "url": mac_arm["browser_download_url"],
                "signature": sig_content
              }
          elif mac_universal and mac_universal_sig:
            sig_content = fetch_text(mac_universal_sig["browser_download_url"])
            if sig_content:
              platforms["darwin-aarch64"] = {
                "url": mac_universal["browser_download_url"],
                "signature": sig_content
              }
          
          # Intel Mac: ä½¿ç”¨ universal
          if mac_universal and mac_universal_sig:
            sig_content = fetch_text(mac_universal_sig["browser_download_url"])
            if sig_content:
              platforms["darwin-x86_64"] = {
                "url": mac_universal["browser_download_url"],
                "signature": sig_content
              }
          
          # Windows
          if win_exe and win_sig:
            sig_content = fetch_text(win_sig["browser_download_url"])
            if sig_content:
              platforms["windows-x86_64"] = {
                "url": win_exe["browser_download_url"],
                "signature": sig_content
              }
          
          if not platforms:
            print("ERROR: No platforms collected", file=sys.stderr)
            sys.exit(1)
          
          pub_date = data.get("published_at") or data.get("created_at") or ""
          notes = data.get("body") or ""
          
          out = {
            "version": version or tag,
            "notes": notes,
            "pub_date": pub_date,
            "platforms": platforms
          }
          
          with open("latest.json", "w", encoding="utf-8") as f:
            json.dump(out, f, ensure_ascii=False, indent=2)
          
          print("Generated latest.json with platforms:", ", ".join(platforms.keys()))
          PY
          
          gh release upload "$TAG" latest.json --clobber --repo "$REPO"
